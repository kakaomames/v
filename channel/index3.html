<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <div id="channel-info">
        チャンネル情報を取得中...
    </div>
    <div id="video-list"></div>

    <script>
        const apiUrl = 'https://test-five-gules-98.vercel.app'; // Flask APIのURL
        const params = new URLSearchParams(window.location.search);
        const channelId = params.get('c'); // URLのクエリパラメータからチャンネルIDを取得
        const channelInfoDiv = document.getElementById('channel-info');
        const videoListDiv = document.getElementById('video-list');

        if (channelId) {
            fetch(`${apiUrl}/channel/${channelId}`)
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');

                    // ytInitialDataを取得
                    const scriptTags = doc.querySelectorAll('script');
                    let ytData = null;
                    scriptTags.forEach(script => {
                        if (script.textContent.includes('ytInitialData')) {
                            const match = script.textContent.match(/ytInitialData\s*=\s*(\{.*?\});/);
                            if (match) {
                                ytData = JSON.parse(match[1]);
                            }
                        }
                    });

                    // 動画リストを生成
                    if (ytData) {
                        const videoItems = ytData.contents.twoColumnBrowseResultsRenderer.tabs[1].tabRenderer.content.richGridRenderer.contents;
                        let videoHtml = '<h2>動画一覧</h2><ul>';
                        videoItems.forEach(item => {
                            if (item.richItemRenderer) {
                                const video = item.richItemRenderer.content.videoRenderer;
                                if (video) {
                                    const title = video.title.runs[0].text;
                                    const videoId = video.videoId;
                                    const thumbnail = video.thumbnail.thumbnails[0].url;
                                    videoHtml += `<li><img src="${thumbnail}" alt="${title}" width="120"> <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank">${title}</a></li>`;
                                }
                            }
                        });
                        videoHtml += '</ul>';
                        videoListDiv.innerHTML = videoHtml;
                    }

                    // 不要な <script> タグを削除
                    doc.querySelectorAll('script').forEach(script => {
                        if (!script.textContent.includes('ytInitialData') && !script.type.includes('application/ld+json')) {
                            script.remove();
                        }
                    });

                    // フィルタリング後のHTMLを適用
                    channelInfoDiv.innerHTML = doc.body.innerHTML;
                })
                .catch(error => {
                    channelInfoDiv.textContent = 'チャンネル情報の取得に失敗しました。';
                    console.error('チャンネル情報取得エラー:', error);
                });
        } else {
            channelInfoDiv.textContent = 'チャンネルIDがありません。URLを確認してください。';
        }
    </script>
</body>
</html>
